/**
 * æå‡ºçŠ¶æ³ã®ç¢ºèªã¨å„ç¨®é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ã§ã™ã€‚
 * æå‡ºãŒæœˆã‚’ã¾ãŸã„ã§é…ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€éå»ã®å…¨ã¦ã®æœªå®Œäº†æœˆã‚’è¿½è·¡ã—ã¾ã™ã€‚
 * 1. æ¯æœˆ20æ—¥ï¼ˆã¾ãŸã¯ç¿Œå–¶æ¥­æ—¥ï¼‰ã«ã€æå‡ºä¾é ¼ã‚’é€šçŸ¥ã—ã¾ã™ã€‚
 * 2. éå»ã«æœªå®Œäº†ã®æœˆãŒã‚ã‚Œã°ã€æœ€ã‚‚å¤ã„æœˆã®æœªæå‡ºè€…ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚
 * 3. éå»ã®æœˆãŒå®Œäº†ã—ãŸã®ã‚’æ¤œçŸ¥ã—ãŸã‚‰ã€ãã®æ™‚ç‚¹ã§å®Œäº†å ±å‘Šã‚’ã—ã¾ã™ã€‚
 * 4. éå»ã®æœˆãŒå…¨ã¦å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€å½“æœˆã®ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆ25æ—¥ä»¥é™ï¼‰ã‚’è¡Œã„ã¾ã™ã€‚
 * 5. ã€ŒæœªåŠ å…¥ã€ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æœˆã®ã¿ã€æœªåŠ å…¥è€…ã‚’ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚
 * * ã“ã®é–¢æ•°ã‚’æ¯æ—¥å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’1ã¤è¨­å®šã—ã¦ãã ã•ã„ã€‚
 */
function notifyReceiptStatusWithSummary() {
  // --- åŸºæœ¬è¨­å®š ---
  const SPREADSHEET_NAME = "æå‡ºçŠ¶æ³";
  const STATUS_COLUMN_HEADER = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";
  const ID_COLUMN_HEADER = "ID";
  const SUBMITTED_VALUE = "æ¸ˆ";
  const UNSUBSCRIBED_VALUE = "æœªåŠ å…¥";
  // æ©Ÿå¯†æƒ…å ±ã¯ScriptPropertiesã‹ã‚‰å–å¾—
  const properties = PropertiesService.getScriptProperties();
  const SLACK_WEBHOOK_URL = properties.getProperty('SLACK_WEBHOOK_URL') || '';
  const SLACK_WEBHOOK_URL_ADMIN = properties.getProperty('SLACK_WEBHOOK_URL_ADMIN') || '';
  const SLACK_WEBHOOK_DRIVE_STORAGE = properties.getProperty('SLACK_WEBHOOK_DRIVE_STORAGE') || '';
  const FORM_ID = properties.getProperty('FORM_ID') || '';
  const FORM_URL = FORM_ID ? `https://docs.google.com/forms/d/${FORM_ID}/edit` : '';
  const TARGET_MONTH_QUESTION_TITLE = "æå‡ºå¯¾è±¡æœˆ";
  const INITIAL_REMINDER_DAY = 20;
  const SUBMISSION_CHECK_START_DAY = 25;

  // --- æ—¥ä»˜é–¢é€£ã®æº–å‚™ ---
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();

  // --- â˜…â˜…â˜… 1. æ¯æœˆ20æ—¥ã®æå‡ºä¾é ¼é€šçŸ¥ â˜…â˜…â˜… ---
  let initialReminderDate = new Date(year, month, INITIAL_REMINDER_DAY);
  // 20æ—¥ãŒåœŸæ—¥ç¥æ—¥ã®å ´åˆã¯ç¿Œå–¶æ¥­æ—¥ã«ãšã‚‰ã™
  while (isWeekend(initialReminderDate) || isJapaneseHoliday(initialReminderDate)) {
    initialReminderDate.setDate(initialReminderDate.getDate() + 1);
  }
  if (today.getFullYear() === initialReminderDate.getFullYear() &&
      today.getMonth() === initialReminderDate.getMonth() &&
      today.getDate() === initialReminderDate.getDate()) {
    const targetMonthStr = `${year}å¹´${month + 1}æœˆåˆ†`;
    const message = `ğŸ“¢ã€ChatGPT é ˜åæ›¸æå‡ºã®ãŠé¡˜ã„ã€‘\n\nãŠç–²ã‚Œæ§˜ã§ã™ï¼\nä»Šæœˆåˆ†ã®ChatGPTã«é–¢ã™ã‚‹é ˜åæ›¸ã®æå‡ºã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\né ˜åæ›¸å–å¾—æ–¹æ³•ã¯ã“ã¡ã‚‰ğŸ‘‡\nhttps://showroom.esa.io/posts/11417\n\næå‡ºãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰ğŸ‘‡\nğŸ“„ https://forms.gle/AS3s9VZ6iG1AwT1FA\n\nå¯¾è±¡æœˆï¼š${targetMonthStr}\nç· åˆ‡ï¼šæœˆæœ«ã¾ã§\n\nã”ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼`;
    sendSlackNotification(message, SLACK_WEBHOOK_URL);
    Logger.log(`æå‡ºä¾é ¼ã®é€šçŸ¥ï¼ˆ${targetMonthStr}ï¼‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
    return;
  }

  // --- â˜…â˜…â˜… 2. ãƒªãƒã‚¤ãƒ³ãƒ‰ã¨å®Œäº†å ±å‘Š â˜…â˜…â˜… ---
  // åœŸæ—¥ç¥æ—¥ã¯ãƒªãƒã‚¤ãƒ³ãƒ‰ã¨å®Œäº†å ±å‘Šã‚’è¡Œã‚ãªã„
  if (isWeekend(today) || isJapaneseHoliday(today)) {
    Logger.log("é€šçŸ¥å¯¾è±¡å¤–ã®æ—¥ï¼ˆåœŸæ—¥ã¾ãŸã¯ç¥æ—¥ï¼‰ã®ãŸã‚ã€å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
    return;
  }

  // --- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿å–å¾— ---
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SPREADSHEET_NAME);
  if (!sheet) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆã€Œ${SPREADSHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    return;
  }
  const allValues = sheet.getDataRange().getValues();
  const headerRow = allValues[0];
  const idColIndex = headerRow.indexOf(ID_COLUMN_HEADER);
  const statusIndex = headerRow.indexOf(STATUS_COLUMN_HEADER);
  if (idColIndex === -1 || statusIndex === -1) {
    Logger.log(`ã‚¨ãƒ©ãƒ¼: ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œ${ID_COLUMN_HEADER}ã€ã¾ãŸã¯ã€Œ${STATUS_COLUMN_HEADER}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    return;
  }
  
  // --- æå‡ºçŠ¶æ³ã®é›†è¨ˆã‚’è¡Œã†å…±é€šé–¢æ•° ---
  const getSubmissionStatus = (targetCol) => {
    let submitted = 0;
    let unsubmitted = 0;
    const mentions = [];
    
    // å¯¾è±¡æœˆã«ã€ŒæœªåŠ å…¥ã€ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    let hasUnsubscribed = false;
    for (let i = 1; i < allValues.length; i++) {
        const status = allValues[i][targetCol] ? allValues[i][targetCol].toString().trim() : '';
        if (status === UNSUBSCRIBED_VALUE) {
            hasUnsubscribed = true;
            break;
        }
    }

    for (let i = 1; i < allValues.length; i++) {
        const row = allValues[i];
        if (row[statusIndex] === "æœ‰åŠ¹") {
            const userId = row[idColIndex];
            const submissionStatus = row[targetCol] ? row[targetCol].toString().trim() : '';
            
            if (submissionStatus === SUBMITTED_VALUE) {
                submitted++;
            } else {
                let isUnsubmitted = false;
                if (hasUnsubscribed) {
                    if (submissionStatus !== UNSUBSCRIBED_VALUE) isUnsubmitted = true;
                } else {
                    isUnsubmitted = true;
                }
                if (isUnsubmitted) {
                    unsubmitted++;
                    if (userId) mentions.push(`<@${userId}>`);
                }
            }
        }
    }
    return { submittedCount: submitted, unsubmittedCount: unsubmitted, unsubmittedMentions: mentions };
  };
  
  // --- é€šçŸ¥å¯¾è±¡æœˆã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ ---
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜å½¢å¼ã®åˆ— ("YYYYå¹´Mæœˆ") ã‚’å…¨ã¦æ¢ã—ã€éå»ã®ã‚‚ã®ã‹ã‚‰é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹
  const monthColumns = [];
  // ã€Œéå»ã®æœˆã€ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã€å½“æœˆã®åˆæ—¥ã‚’å–å¾—
  const beginningOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  for (let i = 0; i < headerRow.length; i++) {
    const header = headerRow[i];
    const match = header.match(/^(\d{4})å¹´(\d{1,2})æœˆ$/);
    if (match) {
      const monthDate = new Date(parseInt(match[1], 10), parseInt(match[2], 10) - 1, 1);
      // å½“æœˆã‚ˆã‚Šå‰ã®æœˆã®ã¿ã‚’ã€Œéå»ã®æœˆã€ã¨ã—ã¦å¯¾è±¡ã«ã™ã‚‹
      if (monthDate < beginningOfCurrentMonth) {
        monthColumns.push({ header: header, index: i, date: monthDate });
      }
    }
  }
  monthColumns.sort((a, b) => a.date - b.date); // å¤ã„é †ã«ã‚½ãƒ¼ãƒˆ

  const scriptProperties = PropertiesService.getScriptProperties();
  const completedMonthsStr = scriptProperties.getProperty('completedMonths') || '{}';
  const completedMonths = JSON.parse(completedMonthsStr);

  // --- éå»ã®æœªå®Œäº†æœˆã‚’ãƒã‚§ãƒƒã‚¯ & å‡¦ç† ---
  for (const col of monthColumns) {
    if (!completedMonths[col.header]) {
      const status = getSubmissionStatus(col.index);
      
      if (status.unsubmittedCount > 0) {
        // æœªæå‡ºè€…ãŒã„ã‚‹ â‡’ æœ€ã‚‚å¤ã„æœªå®Œäº†æœˆã¨ã—ã¦ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡
        Logger.log(`æœ€ã‚‚å¤ã„æœªå®Œäº†æœˆ (${col.header}) ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚`);
        let message = `*ğŸ“… ${col.header} æå‡ºçŠ¶æ³ (å†ãƒªãƒã‚¤ãƒ³ãƒ‰)*\n`;
        message += `âœ… *æå‡ºæ¸ˆã¿*: ${status.submittedCount}äºº\n`;
        message += `âš ï¸ *æœªæå‡º*: ${status.unsubmittedCount}äºº\n`;
        message += `æå‡ºãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰:https://forms.gle/AS3s9VZ6iG1AwT1FA\n`;
        if (status.unsubmittedMentions.length > 0) {
          message += `\n*æœªæå‡ºã®æ–¹ä¸€è¦§:*\n`;
          message += status.unsubmittedMentions.join(', ') + '\n';
        }
        sendSlackNotification(message, SLACK_WEBHOOK_URL);
        return; // ã“ã®æ—¥ã®å‡¦ç†ã¯ã“ã‚Œã§çµ‚ã‚ã‚Š
      } else {
        // æœªæå‡ºè€…0äºº â‡’ å®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¦è¨˜éŒ²
        Logger.log(`éå»ã®æœˆ (${col.header}) ã®æå‡ºãŒå®Œäº†ã—ãŸã®ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚`);
        const generalCompletionMessage = `*ğŸ“… ${col.header} æå‡ºçŠ¶æ³*\nâœ… *æå‡ºæ¸ˆã¿*: ${status.submittedCount}äºº\nâš ï¸ *æœªæå‡º*: 0äºº\n\nğŸ‰ å…¨å“¡ã®æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n`;
        sendSlackNotification(generalCompletionMessage, SLACK_WEBHOOK_URL);

        // ãƒ•ã‚©ãƒ¼ãƒ ã®æå‡ºå¯¾è±¡æœˆã‚’æ¬¡ã®æœˆã«æ›´æ–°
        const formUpdateResult = updateFormTargetMonth(col.header, FORM_ID, TARGET_MONTH_QUESTION_TITLE);

        // ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ›´æ–°çµæœã‚’åæ˜ 
        let adminMessage = `*ğŸ“… ${col.header} æå‡ºçŠ¶æ³*\nâœ… *æå‡ºæ¸ˆã¿*: ${status.submittedCount}äºº\nâš ï¸ *æœªæå‡º*: 0äºº\n\nğŸ‰ å…¨å“¡ã®æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼\n`;
        if (formUpdateResult.success) {
          adminMessage += `âœ… ãƒ•ã‚©ãƒ¼ãƒ ã®æå‡ºå¯¾è±¡æœˆã‚’${formUpdateResult.nextMonth}ã«æ›´æ–°ã—ã¾ã—ãŸã€‚\n`;
        } else {
          adminMessage += `âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${formUpdateResult.message}\n`;
          adminMessage += `æ‰‹å‹•ã§ã®æ›´æ–°ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼ˆ${FORM_URL}ï¼‰\n`;
        }
        sendSlackNotification(adminMessage, SLACK_WEBHOOK_URL_ADMIN);

        const monthPart = col.header.replace(/^\d{4}å¹´/, '');
        // â˜…â˜…â˜… ä¿®æ­£ç‚¹: @HELP YOU ã‚’ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ â˜…â˜…â˜…
        const driveMessage = `<@U04K5TZ7EB1>\nãŠç–²ã‚Œæ§˜ã§ã™ï¼\n${monthPart}åˆ†ã®ChatGPTã®é ˜åæ›¸ã‚’Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«æ ¼ç´æ¸ˆã¿ã§ã™ã€‚\nã”ç¢ºèªã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        sendSlackNotification(driveMessage, SLACK_WEBHOOK_DRIVE_STORAGE);
        
        completedMonths[col.header] = true;
        scriptProperties.setProperty('completedMonths', JSON.stringify(completedMonths));
        Logger.log(`å®Œäº†é€šçŸ¥æ¸ˆã¿æœˆã¨ã—ã¦ã€Œ${col.header}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
        // å®Œäº†ã—ãŸæœˆãŒ1ã¤è¦‹ã¤ã‹ã£ãŸã‚‰ã€æ¬¡ã®æœˆã«é€²ã¾ãšã«ä¸€æ—¦å‡¦ç†ã‚’çµ‚äº†ã™ã‚‹
        return; 
      }
    }
  }
  
  // --- éå»ã®æœˆãŒå…¨ã¦å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã€å½“æœˆã®å‡¦ç†ã‚’è¡Œã† ---
  if (today.getDate() < SUBMISSION_CHECK_START_DAY) {
    Logger.log(`éå»æœˆã¯å…¨ã¦å®Œäº†æ¸ˆã¿ã€‚å½“æœˆã®ãƒªãƒã‚¤ãƒ³ãƒ‰æœŸé–“å¤–ã§ã™ (${SUBMISSION_CHECK_START_DAY}æ—¥ã‚ˆã‚Šå‰)ã€‚`);
    return;
  }

  const currentMonthHeader = `${year}å¹´${month + 1}æœˆ`;
  const currentMonthColIndex = headerRow.indexOf(currentMonthHeader);

  if (currentMonthColIndex !== -1) {
    const status = getSubmissionStatus(currentMonthColIndex);
    if (status.unsubmittedCount > 0) {
      Logger.log(`å½“æœˆ (${currentMonthHeader}) ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚`);
      let message = `*ğŸ“… ${currentMonthHeader} æå‡ºçŠ¶æ³*\n`;
      message += `âœ… *æå‡ºæ¸ˆã¿*: ${status.submittedCount}äºº\n`;
      message += `âš ï¸ *æœªæå‡º*: ${status.unsubmittedCount}äºº\n`;
      message += `æå‡ºãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰:https://forms.gle/AS3s9VZ6iG1AwT1FA\n`;
      if (status.unsubmittedMentions.length > 0) {
        message += `\n*æœªæå‡ºã®æ–¹ä¸€è¦§:*\n`;
        message += status.unsubmittedMentions.join(', ') + '\n';
      }
      sendSlackNotification(message, SLACK_WEBHOOK_URL);
    } else {
      Logger.log(`å½“æœˆ (${currentMonthHeader}) ã¯å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ã€‚`);
    }
  } else {
    Logger.log(`éå»æœˆã¯å®Œäº†æ¸ˆã¿ã§ã™ãŒã€å½“æœˆ (${currentMonthHeader}) ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
  }
}

// --- ä»¥ä¸‹ã€è£œåŠ©é–¢æ•° ---

/**
 * æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ãŒé€±æœ«ï¼ˆåœŸæ—¥ï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
 * @param {Date} date åˆ¤å®šã—ãŸã„æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {boolean} é€±æœ«ã®å ´åˆã¯ true, ãã†ã§ãªã„å ´åˆã¯ false
 */
function isWeekend(date) {
  const day = date.getDay();
  return day === 0 || day === 6; // 0:æ—¥æ›œæ—¥, 6:åœŸæ›œæ—¥
}

/**
 * Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã€æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ãŒæ—¥æœ¬ã®ç¥æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
 * @param {Date} date åˆ¤å®šã—ãŸã„æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {boolean} ç¥æ—¥ã®å ´åˆã¯ true, ãã†ã§ãªã„å ´åˆã¯ false
 */
function isJapaneseHoliday(date) {
  const calendarId = 'ja.japanese#holiday@group.v.calendar.google.com';
  const calendar = CalendarApp.getCalendarById(calendarId);
  const events = calendar.getEventsForDay(date);
  return events.length > 0;
}

/**
 * Slackã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚
 * @param {string} message é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
 * @param {string} webhookUrl Slackã®Incoming Webhook URL
 */
function sendSlackNotification(message, webhookUrl) {
  const payload = {
    "text": message
  };
  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload)
  };
  try {
    UrlFetchApp.fetch(webhookUrl, options);
  } catch (e) {
    Logger.log(`Slackã¸ã®é€šçŸ¥é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URL: ${webhookUrl}, ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }
}

/**
 * ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œæå‡ºå¯¾è±¡æœˆã€é¸æŠè‚¢ã‚’æ¬¡ã®æœˆã«æ›´æ–°ã—ã¾ã™ã€‚
 * æ—¢å­˜ã®é¸æŠè‚¢ã‚’å…¨ã¦å‰Šé™¤ã—ã€æ–°ã—ã„æœˆã®ã¿ã‚’é¸æŠè‚¢ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚
 * @param {string} completedMonthHeader - å®Œäº†ã—ãŸæœˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¾‹: "2025å¹´5æœˆ"ï¼‰
 * @param {string} formId - ãƒ•ã‚©ãƒ¼ãƒ ID
 * @param {string} questionTitle - è³ªå•é …ç›®ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "æå‡ºå¯¾è±¡æœˆ"ï¼‰
 * @return {Object} {success: boolean, message: string, nextMonth: string}
 */
function updateFormTargetMonth(completedMonthHeader, formId, questionTitle) {
  try {
    // å®Œäº†ã—ãŸæœˆã‹ã‚‰æ¬¡æœˆã‚’è¨ˆç®—
    const match = completedMonthHeader.match(/^(\d{4})å¹´(\d{1,2})æœˆ$/);
    if (!match) {
      return {
        success: false,
        message: `å®Œäº†æœˆã®ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ãŒä¸æ­£ã§ã™: ${completedMonthHeader}`,
        nextMonth: null
      };
    }

    let year = parseInt(match[1], 10);
    let month = parseInt(match[2], 10);
    
    // æ¬¡æœˆã‚’è¨ˆç®—ï¼ˆ12æœˆã®å ´åˆã¯ç¿Œå¹´1æœˆã«ï¼‰
    month += 1;
    if (month > 12) {
      month = 1;
      year += 1;
    }
    
    const nextMonth = `${year}å¹´${month}æœˆ`;

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’å–å¾—
    let form;
    try {
      form = FormApp.openById(formId);
    } catch (e) {
      return {
        success: false,
        message: `ãƒ•ã‚©ãƒ¼ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`,
        nextMonth: nextMonth
      };
    }

    // å…¨ã¦ã®è³ªå•é …ç›®ã‚’å–å¾—
    const items = form.getItems();
    let targetItem = null;

    // ã€Œæå‡ºå¯¾è±¡æœˆã€ã®è³ªå•é …ç›®ã‚’æ¢ã™
    for (let i = 0; i < items.length; i++) {
      if (items[i].getTitle() === questionTitle) {
        targetItem = items[i];
        break;
      }
    }

    if (!targetItem) {
      return {
        success: false,
        message: `ã€Œ${questionTitle}ã€ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã®è³ªå•é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`,
        nextMonth: nextMonth
      };
    }

    // è³ªå•é …ç›®ã®ã‚¿ã‚¤ãƒ—ãŒé¸æŠè‚¢ç³»ï¼ˆLISTã€MULTIPLE_CHOICEï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    const itemType = targetItem.getType();
    if (itemType !== FormApp.ItemType.LIST && itemType !== FormApp.ItemType.MULTIPLE_CHOICE) {
      return {
        success: false,
        message: `ã€Œ${questionTitle}ã€ã¯é¸æŠè‚¢å½¢å¼ã®è³ªå•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¿ã‚¤ãƒ—: ${itemType}ï¼‰ã€‚`,
        nextMonth: nextMonth
      };
    }

    // é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®é¸æŠè‚¢ã‚’å…¨ã¦å‰Šé™¤ã—ã€æ–°ã—ã„æœˆã®ã¿ã‚’è¿½åŠ ï¼‰
    const listItem = targetItem.asListItem();
    
    // æ—¢å­˜ã®é¸æŠè‚¢ã‚’å…¨ã¦å‰Šé™¤
    const existingChoices = listItem.getChoices();
    if (existingChoices.length > 0) {
      listItem.setChoices([]);
    }

    // æ–°ã—ã„æœˆã®é¸æŠè‚¢ã‚’è¿½åŠ 
    listItem.setChoices([listItem.createChoice(nextMonth)]);

    Logger.log(`ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œ${questionTitle}ã€ã‚’${nextMonth}ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`);
    
    return {
      success: true,
      message: `ãƒ•ã‚©ãƒ¼ãƒ ã®æå‡ºå¯¾è±¡æœˆã‚’${nextMonth}ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`,
      nextMonth: nextMonth
    };

  } catch (e) {
    Logger.log(`ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}\nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${e.stack}`);
    return {
      success: false,
      message: `äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`,
      nextMonth: null
    };
  }
}
