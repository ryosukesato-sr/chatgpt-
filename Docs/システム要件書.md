# ChatGPT領収書提出管理システム システム要件書

## 1. システム概要

### 1.1 目的
本システムは、組織内でのChatGPT利用に伴う領収書の提出・管理を効率化するためのGoogle Apps Scriptベースのシステムです。Googleフォームによる提出受付、Googleスプレッドシートによる提出状況管理、Slack連携による通知機能を提供します。

### 1.2 適用範囲
- Google Workspace環境
- Slack連携
- Google Drive上のファイル管理

## 2. 機能要件

### 2.1 提出状況管理機能

#### 2.1.1 フォーム送信時の自動処理
- **機能名**: `recordSubmissionStatusBasedOnActualLayout`
- **トリガー**: Googleフォーム送信時
- **処理内容**:
  - フォームから送信されたメールアドレス、提出対象月、領収書ファイルを取得
  - 「提出状況」シート上で該当するユーザー行・月列を特定
  - 該当セルに「済」を自動入力
  - 新しい月の場合は列を自動追加
  - 提出者のSlackユーザーIDを取得し、Slackに通知を送信

#### 2.1.2 新規ユーザー登録時の自動処理
- **機能名**: `onEdit`
- **トリガー**: スプレッドシート編集時（E列に「有効」が入力された時）
- **処理内容**:
  - 編集が「提出状況」シートのE列（ステータス列）で行われたかチェック
  - E列の値が「有効」で、かつA-D列がすべて入力済みの場合に処理実行
  - ヘッダー行（1行目）の日付列（"YYYY年M月"形式）を取得
  - 現在の月より前の月について、該当セルが空の場合のみ「未加入」を自動入力

### 2.2 提出状況通知機能

#### 2.2.1 定期通知処理
- **機能名**: `notifyReceiptStatusWithSummary`
- **トリガー**: 日次実行（推奨）
- **処理内容**:
  - **毎月20日の提出依頼通知**
    - 20日が土日祝日の場合は翌営業日に自動調整
    - 全員に対して当月分の領収書提出依頼をSlackに送信
    - 領収書取得方法と提出フォームのURLを含める
  - **過去の未完了月のリマインド**
    - 過去の月のうち、最も古い未完了月に対してリマインドを送信
    - 未提出者に対してメンション付きで通知
    - 「未加入」が記載されている月は、未加入者をリマインド対象から除外
  - **完了報告**
    - 過去の月の提出が完了した場合、完了通知を送信
    - 一般チャンネルと管理者チャンネル、ドライブ保管担当者に通知
    - ScriptPropertiesに完了月を記録
  - **当月のリマインド（25日以降）**
    - 過去の月がすべて完了している場合のみ実行
    - 当月の未提出者に対してリマインドを送信

#### 2.2.2 通知除外条件
- 土日祝日はリマインドと完了報告を行わない（提出依頼通知は除く）
- 日本の祝日判定にはGoogleカレンダーの祝日カレンダーを使用

### 2.3 ファイル管理機能

#### 2.3.1 領収書ファイルの自動整理
- **機能名**: `organizeSubmittedReceipt`
- **トリガー**: Googleフォーム送信時
- **処理内容**:
  - フォームでアップロードされた領収書ファイルを取得
  - 提出対象月（"YYYY年M月"形式）から年と月を抽出
  - 指定されたGoogleドライブのCHATGPTフォルダ内に、`YYYY_MM`形式の月別フォルダを作成（存在しない場合）
  - ファイル名を`CHATGPT_{提出者名}_{YYYYMM}.pdf`形式にリネーム
  - ファイルを該当月のフォルダに移動

### 2.4 ユーザー管理機能

#### 2.4.1 Slackユーザー一覧取得
- **機能名**: `getSlackUsers`
- **トリガー**: 手動実行（メニューから実行）
- **処理内容**:
  - Slack APIを使用してワークスペースのユーザー一覧を取得
  - ボットユーザーと削除済みユーザーを除外
  - 「Slackユーザー一覧」シートに以下の情報を出力:
    - メールアドレス
    - ID（SlackユーザーID）
    - ユーザー名
    - 表示名
    - 最終更新日時
    - ボットか
    - 管理者か
    - タイムゾーン
    - ステータス絵文字
    - ステータステキスト
    - 役職

#### 2.4.2 Google Workspaceユーザー一覧取得
- **機能名**: `listAllUsersWithMoreDetails`
- **トリガー**: 手動実行
- **処理内容**:
  - Google Workspace Admin APIを使用して指定ドメインのユーザー一覧を取得
  - 「社員マスタ」シートに以下の情報を出力:
    - 氏名
    - メールアドレス
    - 部署
    - 職種
    - アカウント作成日
    - ステータス
    - 最終ログイン
    - 2段階認証
    - 管理者
    - 次回パスワード変更

## 3. データ構造

### 3.1 スプレッドシート構成

#### 3.1.1 「提出状況」シート
- **列構成**:
  - A列: メールアドレス
  - B-D列: その他の基本情報（氏名、部署等）
  - E列: ステータス（"有効"/"無効"）
  - F列以降: 月別の提出状況（ヘッダー: "YYYY年M月"）
- **データ値**:
  - 提出済み: "済"
  - 未加入: "未加入"
  - 未提出: 空欄

#### 3.1.2 「Slackユーザー一覧」シート
- 自動生成されるシート
- Slack APIから取得したユーザー情報を格納

#### 3.1.3 「社員マスタ」シート
- 自動生成されるシート
- Google Workspaceから取得したユーザー情報を格納

#### 3.1.4 「フォームの回答」シート
- Googleフォームの回答が自動的に記録されるシート
- 列構成（想定）:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 提出対象月
  - D列: 領収書ファイル

### 3.2 ScriptProperties
- `completedMonths`: 完了通知済みの月をJSON形式で保存
  - キー: 月のヘッダー（例: "2025年5月"）
  - 値: true（完了済み）

## 4. 外部連携

### 4.1 Slack連携
- **連携方式**: Incoming Webhook
- **Webhook URL**:
  - 一般通知: `SLACK_WEBHOOK_URL`
  - 管理者通知: `SLACK_WEBHOOK_URL_ADMIN`
  - ドライブ保管通知: `SLACK_WEBHOOK_DRIVE_STORAGE`
- **通知内容**:
  - 提出依頼通知
  - リマインド通知（メンション付き）
  - 完了報告通知
  - フォーム送信時の個別通知

### 4.2 Slack API
- **用途**: ユーザー一覧取得
- **使用API**: `users.list`
- **必要な権限**: `users:read`, `users:read.email`
- **認証方式**: OAuth Token（Bot Token）

### 4.3 Google Workspace Admin API
- **用途**: ユーザー一覧取得
- **使用API**: `AdminDirectory.Users.list`
- **必要な権限**: 管理者権限、Admin SDK API有効化
- **認証方式**: Google Apps Scriptのサービスアカウント

### 4.4 Google Drive API
- **用途**: ファイル管理
- **必要な権限**: 対象フォルダへの読み書き権限

### 4.5 GoogleカレンダーAPI
- **用途**: 日本の祝日判定
- **カレンダーID**: `ja.japanese#holiday@group.v.calendar.google.com`

## 5. 非機能要件

### 5.1 パフォーマンス
- フォーム送信時の処理: 3秒以内
- 日次通知処理: 30秒以内
- ユーザー一覧取得: ユーザー数に応じて可変（100人あたり約5秒）

### 5.2 可用性
- Google Apps Scriptの実行時間制限に準拠
- トリガーの実行タイミングはGoogle Apps Scriptのスケジューラーに依存

### 5.3 セキュリティ
- 機密情報（トークン、Webhook URL）はスクリプト内に直接記述（環境変数化を推奨）
- Google Workspace管理者権限が必要な操作は適切な権限管理を実施
- ファイルアクセス権限は最小限に設定

### 5.4 保守性
- 各機能は独立した関数として実装
- ログ出力によりデバッグを容易に
- 設定値は定数として集約管理

## 6. 運用要件

### 6.1 初期設定
1. Googleスプレッドシートの作成
2. Googleフォームの作成と連携設定
3. トリガーの設定:
   - `onEdit`: スプレッドシート編集時（自動）
   - `recordSubmissionStatusBasedOnActualLayout`: フォーム送信時
   - `organizeSubmittedReceipt`: フォーム送信時
   - `notifyReceiptStatusWithSummary`: 日次実行（推奨: 毎朝9時）
4. Slack Incoming Webhookの設定
5. Slack OAuth Tokenの取得と設定
6. Google Workspace Admin SDK APIの有効化
7. Googleドライブフォルダの作成とID設定

### 6.2 定期メンテナンス
- 月次: 新しい月の列が正しく作成されているか確認
- 四半期: 完了済み月のScriptPropertiesの整理（任意）

### 6.3 エラーハンドリング
- ファイルが見つからない場合のログ出力
- Slack通知失敗時のログ出力
- API呼び出し失敗時のエラーメッセージ表示

## 7. 制約事項

### 7.1 Google Apps Scriptの制約
- 1回の実行時間: 最大6分
- 1日の実行時間: 最大6時間
- トリガーの実行頻度: 1分間隔が最小
- スプレッドシートへの書き込み: 100回/100秒以内

### 7.2 Slack APIの制約
- `users.list` APIのレート制限: Tier 3（適度な制限）

### 7.3 Google Workspace Admin APIの制約
- `Users.list` APIのレート制限: 100リクエスト/100秒/ユーザー

## 8. システム構成図

```
┌─────────────────┐
│  Googleフォーム  │
│  (領収書提出)    │
└────────┬────────┘
         │
         ├──────────────────────────┐
         │                          │
         ▼                          ▼
┌─────────────────┐      ┌──────────────────┐
│   Google Apps   │      │   Google Drive   │
│    Script       │      │  (ファイル整理)   │
└────────┬────────┘      └──────────────────┘
         │
         ├──────────────────────────┐
         │                          │
         ▼                          ▼
┌─────────────────┐      ┌──────────────────┐
│ Google スプレッド│      │      Slack       │
│     シート       │      │   (通知送信)      │
│  (提出状況管理)  │      └──────────────────┘
└─────────────────┘
```

## 9. バージョン情報

- **作成日**: 2025年
- **対象バージョン**: Google Apps Script (最新版)
- **依存サービス**: 
  - Google Workspace
  - Slack
  - Google Drive
  - Google Calendar (祝日カレンダー)

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| - | 1.0 | 初版作成 | - |
